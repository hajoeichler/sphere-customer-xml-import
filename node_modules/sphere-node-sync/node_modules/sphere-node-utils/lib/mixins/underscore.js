var _;

_ = require('underscore');


/**
 * A collection of methods to be used as underscore mixins
 * @example
 *   _ = require 'underscore'
 *   {_u} = require 'sphere-node-utils'
 *   _.mixin _u
 *
 *   # or
 *   _.mixin require('sphere-node-utils')._u
 */

module.exports = {

  /**
   * Returns a deep clone of the given object
   * @param {Object} obj A JSON object
   * @return {Object} A deep clone of the given object
   */
  deepClone: function(obj) {
    if (!obj) {
      return {};
    }
    return JSON.parse(JSON.stringify(obj));
  },

  /**
   * Stringifies a JSON object in a pretty format.
   * In case of a non JSON object, the argument itself is returned (also for Error instances).
   * @param {Object} obj A JSON object
   * @param {Number} [indentation] The indentation number (default 2)
   * @return {String} A pretty string
   */
  prettify: function(obj, indentation) {
    if (indentation == null) {
      indentation = 2;
    }
    if (!obj) {
      return;
    }
    switch (false) {
      case !(obj instanceof Error):
        return obj;
      case !_.isObject(obj):
        return JSON.stringify(obj, null, indentation);
      default:
        return obj;
    }
  },

  /**
   * Returns the percentage of the given values
   * @param {Number} x The current number out of total
   * @param {Number} tot The total number to calculate the percentage
   * @return {Number} The percentage value, rounded
   */
  percentage: function(x, tot) {
    return Math.round(x * 100 / tot);
  },

  /**
   * Returns a URL query string from a key-value object
   * @param {Object} params A JSON object containing key-value query params
   * @return {String} A query string, or empty if params is undefined
   */
  stringifyQuery: function(params) {
    var query;
    if (!params) {
      return "";
    }
    query = _.reduce(params, function(memo, value, key) {
      memo.push("" + key + "=" + value);
      return memo;
    }, []);
    return query.join("&");
  },

  /**
   * Returns a key-value JSON object from a query string
   * @param {String} query A query string
   * @return {Object} A JSON object (note that all values are parsed as string)
   */
  parseQuery: function(query) {
    if (!query) {
      return {};
    }
    return _.reduce(query.split('&'), function(memo, param) {
      var key, splitted, value;
      splitted = param.split('=');
      if (_.size(splitted) < 2) {
        return memo;
      }
      key = splitted[0];
      value = splitted[1];
      memo[key] = value;
      return memo;
    }, {});
  }
};
